name: Global Deployment Logic

on:
  repository_dispatch: # Lắng nghe tín hiệu từ các repo khác
    types: [deploy-event]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Lightsail via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.LIGHTSAIL_IP }}
          username: ubuntu
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            mkdir -p ~/app
            cd ~/app

            # 1. Tự động tạo/ghi đè file .env từ GitHub Secrets
            echo "DB_URL=${{ secrets.DB_URL }}" > .env
            echo "DB_USER=${{ secrets.DB_USER }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "EMAIL_USERNAME=${{ secrets.EMAIL_USERNAME }}" >> .env
            echo "EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}" >> .env

            # 2. Lấy file docker-compose mới nhất (có thể dùng curl từ GitHub hoặc git pull)
            # Ở đây Nyanko ví dụ dùng curl để lấy file nhanh nhất
            curl -s https://raw.githubusercontent.com/${{ github.repository }}/main/docker-compose.yml -o docker-compose.yml

            # 3. Pull image mới và khởi động lại
            sudo docker compose pull
            sudo docker compose up -d
